<!doctype html><html lang=en><head><title>How to Setup WireGuard VPN :: alexander_ruf</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="WireGuard has become a popular VPN protocol due to its simplicity and security. I created this guide because as a non-Linux administrator and non-network professional, I found it quite difficult to find correct and complete instructions on how to set up my own VPN with WireGuard. The official documentation didn&amp;rsquo;t help me much in this either.
WireGuard Server and Client The goal here is to set up a WireGuard server on Ubuntu Server 20."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://www.alexruf.net/posts/how-to-setup-wireguard-vpn/><link rel=stylesheet href=https://www.alexruf.net/assets/style.css><link rel=stylesheet href=https://www.alexruf.net/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://www.alexruf.net/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://www.alexruf.net/img/favicon.png><meta name=twitter:card content="summary"><meta name=twitter:title content="How to Setup WireGuard VPN"><meta name=twitter:description content="WireGuard has become a popular VPN protocol due to its simplicity and security. I created this guide because as a non-Linux administrator and non-network professional, I found it quite difficult to find correct and complete instructions on how to set up my own VPN with WireGuard. The official documentation didn&rsquo;t help me much in this either.
WireGuard Server and Client The goal here is to set up a WireGuard server on Ubuntu Server 20."><meta property="og:title" content="How to Setup WireGuard VPN"><meta property="og:description" content="WireGuard has become a popular VPN protocol due to its simplicity and security. I created this guide because as a non-Linux administrator and non-network professional, I found it quite difficult to find correct and complete instructions on how to set up my own VPN with WireGuard. The official documentation didn&rsquo;t help me much in this either.
WireGuard Server and Client The goal here is to set up a WireGuard server on Ubuntu Server 20."><meta property="og:type" content="article"><meta property="og:url" content="https://www.alexruf.net/posts/how-to-setup-wireguard-vpn/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-07T22:17:45+02:00"><meta property="article:modified_time" content="2020-07-07T22:17:45+02:00"><meta property="og:site_name" content="alexander_ruf"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>alexander_ruf</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li><ul class=menu__sub-inner><li class=menu__sub-inner-more-trigger>Show more
<span class=menu__sub-inner-more-trigger-icon><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span></li><ul class="menu__sub-inner-more hidden"><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h2 class=post-title><a href=https://www.alexruf.net/posts/how-to-setup-wireguard-vpn/>How to Setup WireGuard VPN</a></h2><div class=post-meta><span class=post-date>2020-07-07</span>
<span class=post-author>— Written by Alexander</span></div><span class=post-tags>#<a href=https://www.alexruf.net/tags/linux/>linux</a>&nbsp;
#<a href=https://www.alexruf.net/tags/networking/>networking</a>&nbsp;</span><div class=post-content><p>WireGuard has become a popular VPN protocol due to its simplicity and security. I created this guide because as a non-Linux administrator and non-network professional, I found it quite difficult to find correct and complete instructions on how to set up my own VPN with WireGuard. The official documentation didn&rsquo;t help me much in this either.</p><h2 id=wireguard-server-and-client>WireGuard Server and Client</h2><p>The goal here is to set up a WireGuard server on Ubuntu Server 20.04 LTS and two clients, one each on macOS and iOS. Also, the WireGuard VPN we&rsquo;ll go to set up should allow connections with both <strong>IPv4 and IPv6</strong>.
The WireGuard server will be responsible for accepting connections from the clients, so it&rsquo;s best to assign this role to a computer with a stable and decent network connection. I&rsquo;ll run the WireGuard server on a small cloud VPS instance. Therefore, all of my other devices, such as my MacBook and iPhone, are the clients in this setup.</p><p>With WireGuard you need to assign static IP addresses for all devices in the VPN network. So let&rsquo;s start with this:</p><table><thead><tr><th>Device</th><th> IPv4</th><th> IPv6</th></tr></thead><tbody><tr><td>Server</td><td> 10.0.0.1</td><td>fd00::1</td></tr><tr><td>MacBook</td><td> 10.0.0.10</td><td>fd00::10</td></tr><tr><td>iPhone</td><td> 10.0.0.20</td><td>fd00::20</td></tr></tbody></table><h2 id=install-wireguard-on-server>Install WireGuard on server</h2><p>On the server we start with the installation of the software.
But before we continue, let&rsquo;s ensure everything is up to date:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt upgrade
</span></span><span style=display:flex><span>sudo reboot
</span></span></code></pre></div><p>Fortunately Ubuntu Server 20.04 LTS already comes with everything we need.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install wireguard
</span></span></code></pre></div><p>Since WireGuard requires its kernel module to be loaded, we should ensure this is the case:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo modprobe wireguard
</span></span></code></pre></div><p>With the following command you can verify the kernel module is successfully loaded:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lsmod | grep wireguard
</span></span></code></pre></div><h2 id=generate-the-keypair-for-encryption>Generate the keypair for encryption</h2><p>We start by generating the the keypair for encrypting the connections.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su -
</span></span><span style=display:flex><span>cd /etc/wireguard
</span></span><span style=display:flex><span>umask <span style=color:#ae81ff>077</span>
</span></span><span style=display:flex><span>wg genkey | sudo tee privatekey | wg pubkey | sudo tee publickey
</span></span></code></pre></div><p>The <code>/etc/wireguard</code> directory should now contain two files, with both the private key (<code>privatekey</code>) and public key (<code>publickey</code>).</p><h2 id=create-wireguard-server-configuration>Create WireGuard server configuration</h2><p>Now that the WireGuard software is installed on the server, and the keypair for encryption is generated, we can start configuring the server.</p><p>If not told otherwise, WireGuard will look for a configuration file associated with the corresponding network interface in <code>/etc/wireguard</code>. Since I decided to name the network interface used for WireGuard <code>wg0</code>, the corresponding configuration file would be <code>/etc/wireguard/wg0.conf</code> — so let&rsquo;s create it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>touch /etc/wireguard/wg0.conf
</span></span></code></pre></div><p>The next step is to open and edit the configuration file with the editor of your choice. Make sure to replace all four instances of <code>ens2</code> with the name of your network interface which is connected to the internet. If you are unsure, you can look up the correct name with the command <code>ip link show</code> or <code>ifconfig</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#66d9ef>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Address</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10.0.0.1/32,fd00::1/128</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PostUp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>sysctl -w net.ipv4.ip_forward=1 &amp;&amp; sysctl -w net.ipv6.conf.all.forwarding=1 &amp;&amp; iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o ens2 -j MASQUERADE; ip6tables -A FORWARD -i %i -j ACCEPT; ip6tables -t nat -A POSTROUTING -o ens2 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PostDown</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o ens2 -j MASQUERADE; ip6tables -D FORWARD -i %i -j ACCEPT; ip6tables -t nat -D POSTROUTING -o ens2 -j MASQUERADE &amp;&amp; sysctl -w net.ipv6.conf.all.forwarding=0 &amp;&amp; sysctl -w net.ipv4.ip_forward=0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ListenPort</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>51820</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PrivateKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;Server Private Key&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;First Client Private Key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10.0.0.10/32,fd00::10/128</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PersistentKeepalive</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>25</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;Second Client Private Key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10.0.0.20/32,fd00::20/128</span>
</span></span></code></pre></div><p>Next we need to allow forwarding of incomming connections on the <code>wg0</code> network interface and allow incomming connections on UDP port <code>51820</code> from the clients:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ufw route allow in on wg0
</span></span><span style=display:flex><span>sudo ufw allow 51820/udp
</span></span></code></pre></div><p>Among the WireGuard tools is the bash script <code>/usr/bin/wg-quick</code>. The script allows to easily bring up and shut down WireGuard interfaces. In case <code>wg-quick</code> finds a configuration file for the respective interface in the directory <code>/etc/wireguard</code>, it will create the interface, assign an IP address and routes or even run pre and post-up scripts.</p><p>Enable the WireGuard interface, and ensure it automatically gets restarted after boot:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo wg-quick up wg0
</span></span><span style=display:flex><span>sudo systemctl enable wg-quick@wg0
</span></span></code></pre></div><p>Remember to stop (<code>sudo wg-quick down wg0</code>) and restart (<code>sudo wg-quick up wg0</code>) the interface every time the configuration file is changed.</p><h2 id=configure-wireguard-client-on-macos>Configure WireGuard client on macOS</h2><p>The official WireGuard page contains <a href=https://www.wireguard.com/install/>installation</a> instructions for may different operating systems. However, the macOS client can directly be downloaded from the <a href="https://itunes.apple.com/us/app/wireguard/id1451685025?ls=1&mt=12">App Store</a>.</p><p>Once the client is installed, click <code>Add Empty Tunnel</code>.</p><p><img src=/content/images/wireguard-macos-new-config.png alt="WireGuard macOS client new config"></p><p>A private and a public key are automatically generated and the client configuration is prefilled. Edit the configuration using the following tempalte.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#66d9ef>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PrivateKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;Client Private Key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># the static IPv4 and IPv6 address assigned to the client</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Address</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10.0.0.10/32, fd00::10/128</span>
</span></span><span style=display:flex><span><span style=color:#75715e># choose any DNS service like Quad9, Cloudflare, Google, etc.</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>DNS</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>9.9.9.9</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;Server Public Key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># route all IPv4 and IPv6 addresses through the VPN</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>0.0.0.0/0, ::/0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Endpoint</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;server-address_or_ip&gt;:51820</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PersistentKeepalive</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>25</span>
</span></span></code></pre></div><p><img src=/content/images/wireguard-macos-client-config.png alt="WireGuard macOS client configuration"></p><h2 id=add-new-client-peer-to-server>Add new client peer to server</h2><p>In order to allow the new client to connect to the WireGuard server, we need to add a new peer in its configuration file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;Client Public Key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10.0.0.10/32,fd00::10/128</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PersistentKeepalive</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>25</span>
</span></span></code></pre></div><p>That&rsquo;s it, after restarting the interface, the configuration becomes active and the client should be able to connect the VPN.</p><h2 id=configure-wireguard-client-on-ios>Configure WireGuard client on iOS</h2><p>Last but not least we will set up the WireGuard client on iOS. The iOS client can also be downloaded from the <a href="https://itunes.apple.com/us/app/wireguard/id1441195209?ls=1&mt=8">App Store</a>. The set up process basically follows the same procedure.</p><p>Start by adding a new configuration from scratch.</p><p><img src=/content/images/wireguard-ios-new-config.png alt="WireGuard iOS client new config"></p><p>Instead of having to edit the configuration manually, iOS offers a graphical interface for this purpose.</p><p><img src=/content/images/wireguard-ios-client-config.png alt="WireGuard iOS client configuration"></p><h2 id=add-another-client-peer-to-server>Add another client peer to server</h2><p>To finalize our WireGuard VPN we add a second peer for the iOS client to the server configuration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;Client Public Key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10.0.0.20/32,fd00::20/128</span>
</span></span></code></pre></div><p>Note that in order to save some battery on the mobile device, <code>PersistentKeepalive</code> is turned off here for this client.</p><p>After restarting the WireGuard interface once again for the last time, your VPN is now ready to be used.</p><h1 id=conclusion>Conclusion</h1><p>As you can see, setting up and running your own VPN with WireGuard is relatively easy once you know how to do it. So there&rsquo;s no need to pay money to questionable VPN providers. Instead, you can run your own VPN server on a cheap virtual private server for little money (plus you can do a lot of other things with your own VPN).</p><p>If you think something in this guide is wrong or can be improved, please let me know!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://www.alexruf.net/posts/deploy-gitea-woodpecker-docker-compose/><span class=button__icon>←</span>
<span class=button__text>Deploy Gitea and Woodpecker CI with Docker Compose</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>alexander_ruf</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2022 Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by <a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://www.alexruf.net/assets/main.js></script>
<script src=https://www.alexruf.net/assets/prism.js></script></div></body></html>